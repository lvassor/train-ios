# Programme Generation Architecture

**Version:** 4.0.0
**Last Updated:** January 24, 2026
**Status:** Production

## Overview

This document describes the complete architecture for trAIn's programme generation system, from source data through to exercise selection in the iOS app.

---

## 1. File Architecture

### Source Files (database-management/)
| File | Purpose |
|------|---------|
| `constants.json` | Single source of truth for all mappings |
| `train_exercise_database_prod.csv` | Exercise data (220 exercises) |
| `train_exercise_contraindications_prod.csv` | Injury contraindications |
| `exercise_video_mapping.csv` | Bunny.net video URLs |
| `create_database_prod.py` | Database generator script |

### Generated/Runtime Files (trAInSwift/Resources/)
| File | Purpose |
|------|---------|
| `exercises.db` | SQLite database (generated by Python) |
| `constants.json` | Copy for Swift runtime (must sync with source) |
| `split_templates.json` | Split configurations |
| `bunny_video_library.json` | Video library metadata |

### Data Flow Pipeline
```
CSV Source Files
    ↓
constants.json (mappings)
    ↓
Python Script (create_database_prod.py)
    ↓
SQLite Database (exercises.db) → trAInSwift/Resources/
    ↓
Swift App (GRDB models) ← ConstantsManager ← constants.json
```

---

## 2. Database Schema

### 2.1 exercises Table

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `exercise_id` | TEXT | PRIMARY KEY | Unique ID (e.g., "EX001") |
| `canonical_name` | TEXT | NOT NULL | Movement pattern grouping (e.g., "Bench Press") |
| `display_name` | TEXT | NOT NULL | User-facing name (e.g., "Barbell Flat Bench Press") |
| `equipment_category` | TEXT | NOT NULL | High-level equipment (e.g., "Barbells", "Cables") |
| `equipment_specific` | TEXT | NULLABLE | Specific equipment (e.g., "Squat Rack") |
| `attachment_specific` | TEXT | NULLABLE | Cable attachments (e.g., "Rope", "D-Handles") |
| `complexity_level` | TEXT | NOT NULL, CHECK('all','1','2') | Exercise complexity |
| `primary_muscle` | TEXT | NOT NULL | Main muscle targeted |
| `secondary_muscle` | TEXT | NULLABLE | Secondary muscle |
| `instructions` | TEXT | NULLABLE | Exercise instructions |
| `is_in_programme` | INTEGER | NOT NULL, DEFAULT 1 | Include in programme (0/1) |
| `canonical_rating` | INTEGER | NOT NULL, CHECK(0-100) | MCV ordering score |
| `progression_id` | TEXT | NULLABLE | Comma-separated progression IDs |
| `regression_id` | TEXT | NULLABLE | Comma-separated regression IDs |

#### Complexity Level Meanings
- `"all"` = Available to everyone
- `"1"` = No experience / Beginner only
- `"2"` = Intermediate / Advanced only

#### Canonical Rating Guidelines
- 0-30: Isolation exercises (e.g., Bicep Curl)
- 40-60: Moderate compound (e.g., Romanian Deadlift)
- 80-100: Primary compound (e.g., Squat, Deadlift, Bench Press)

### 2.2 exercise_contraindications Table

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | INTEGER | PRIMARY KEY AUTOINCREMENT | Row ID |
| `canonical_name` | TEXT | NOT NULL | Links to exercises.canonical_name |
| `injury_type` | TEXT | NOT NULL | Injury type (e.g., "Back", "Shoulders") |

**Unique constraint:** `(canonical_name, injury_type)`

### 2.3 exercise_videos Table

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | INTEGER | PRIMARY KEY AUTOINCREMENT | Row ID |
| `exercise_id` | TEXT | NOT NULL, FK | Links to exercises.exercise_id |
| `supplier_id` | TEXT | NULLABLE | Video supplier ID |
| `media_type` | TEXT | NOT NULL, CHECK('vid','img') | Media type |
| `filename` | TEXT | NOT NULL | Original filename |
| `bunny_url` | TEXT | NOT NULL | Full CDN URL |
| `note` | TEXT | NULLABLE | Notes |

### 2.4 Indexes

```sql
-- Exercise lookups
idx_exercises_canonical ON exercises(canonical_name)
idx_exercises_category ON exercises(equipment_category)
idx_exercises_specific ON exercises(equipment_specific)
idx_exercises_attachment ON exercises(attachment_specific)
idx_exercises_complexity ON exercises(complexity_level)
idx_exercises_muscle ON exercises(primary_muscle)
idx_exercises_programme ON exercises(is_in_programme)
idx_exercises_rating ON exercises(canonical_rating)

-- Contraindications
idx_contraindications_canonical ON exercise_contraindications(canonical_name)
idx_contraindications_injury ON exercise_contraindications(injury_type)

-- Videos
idx_videos_exercise_id ON exercise_videos(exercise_id)
idx_videos_media_type ON exercise_videos(media_type)
```

---

## 3. Constants & Mappings

### 3.1 Equipment Mappings
Maps questionnaire UI keys to database values:

| Questionnaire Key | Database Value |
|-------------------|----------------|
| `bodyweight` | `Bodyweight` |
| `barbells` | `Barbells` |
| `dumbbells` | `Dumbbells` |
| `kettlebells` | `Kettlebells` |
| `cable_machines` | `Cables` |
| `pin_loaded` | `Pin-Loaded Machines` |
| `plate_loaded` | `Plate-Loaded Machines` |
| `other` | `Other` |

### 3.2 Attachment Mappings
Maps questionnaire UI keys to database values:

| Questionnaire Key | Database Value |
|-------------------|----------------|
| `straight_bar` | `Straight Bar` |
| `rope` | `Rope` |
| `d_handles` | `D-Handles` |
| `ez_bar` | `EZ-Bar` |
| `ez_bar_cable` | `EZ-Bar Cable` |
| `ankle_strap` | `Ankle Strap` |
| `resistance_band` | `Resistance Band` |
| `weight_belt` | `Weight Belt` |

**Cable Attachments:** `Straight Bar`, `Rope`, `D-Handles`, `EZ-Bar Cable`

### 3.3 Experience Level Mappings

| Questionnaire Key | Database/App Value |
|-------------------|-------------------|
| `no_experience` | `NO_EXPERIENCE` |
| `beginner` | `BEGINNER` |
| `intermediate` | `INTERMEDIATE` |
| `advanced` | `ADVANCED` |

---

## 4. App Flow: Questionnaire to Programme

### 4.1 Chronological Flow

```
1. User completes questionnaire
   ├── Equipment selection → equipmentAvailable[]
   ├── Attachment selection → detailedEquipment["attachments"]
   ├── Experience level → experienceLevel
   ├── Goals → primaryGoals[]
   ├── Target muscles → targetMuscleGroups[]
   ├── Training days → trainingDaysPerWeek
   └── Split selection → selectedSplit

2. DynamicProgramGenerator receives QuestionnaireData
   ├── Map equipment: questionnaire keys → DB values
   ├── Map attachments: questionnaire keys → DB values
   ├── Check attachment warning (cables without attachments)
   └── Determine split type from selectedSplit or daysPerWeek

3. Generate sessions for split
   ├── Load session templates from split_templates.json
   ├── For each session template:
   │   └── For each muscle slot:
   │       └── Select exercises using MCV algorithm

4. MCV Exercise Selection (per muscle slot)
   ├── Build user pool (filter by equipment, attachments, complexity)
   ├── Filter by muscle group
   ├── Apply exclusions (already used IDs, display names, canonical names)
   ├── Select highest canonical_rating exercise
   └── Remove from candidate pools

5. Assign sets/reps/rest based on goals

6. Return ProgramGenerationResult with warnings
```

### 4.2 Filtering Chain

```swift
// Stage 1: Database query filters
ExerciseDatabaseFilter {
    equipmentCategories: [String]     // User's equipment
    attachmentSpecific: [String]      // User's attachments
    maxComplexity: Int                // Based on experience
    primaryMuscle: String?            // Target muscle
    excludeExerciseIds: Set<String>   // Already used
}

// Stage 2: In-memory filters (MCV)
- excludedDisplayNames: Set<String>   // Programme-level (no exact repeats)
- excludedCanonicalNames: Set<String> // Session-level (no variations)
```

### 4.3 Attachment Filtering Logic

```sql
-- Exercises pass if:
-- 1. attachment_specific IS NULL (no attachment required), OR
-- 2. attachment_specific IN user_selected_attachments

WHERE (attachment_specific IS NULL
       OR attachment_specific IN ('Rope', 'D-Handles', ...))
```

---

## 5. MCV Heuristic Algorithm

### 5.1 Overview
MCV (Most Constrained Variable) ensures we don't get stuck by filling the hardest-to-fill slots first.

### 5.2 Selection Process

```
FOR each session template:
    WHILE slots remain unfilled:
        1. Build candidate lists for all unfilled slots
        2. Find slot with MINIMUM candidates (MCV)
        3. From that slot's candidates:
           - Select exercise with highest canonical_rating
        4. Mark selected:
           - Add canonical_name to session exclusions
           - Add display_name to programme exclusions
        5. Remove exercise from all candidate lists
```

### 5.3 Constraints

**Hard Constraints (never broken):**
- Equipment: user must have it
- Attachments: user must have it (or exercise needs none)
- Complexity: user level must meet minimum
- No canonical_name repeat within session

**Soft Constraints (relaxed if needed):**
- No display_name repeat across sessions → `exerciseRepeats` warning

### 5.4 Ordering
After selection, exercises are sorted by `canonical_rating` descending within each session. Compounds first, isolations last.

---

## 6. Sets, Reps & Rest Assignment

### 6.1 Rep Ranges (Goal-Based)

| Goal | Canonical Rating | Rep Range Options |
|------|-----------------|-------------------|
| Get Stronger only | > 75 | 5-8, 6-10 |
| Get Stronger only | ≤ 75 | 6-10, 8-12 |
| Increase Muscle | All | 6-10, 8-12 |
| Fat Loss | All | 8-12, 10-14 |
| Get Stronger + others | Uses Get Stronger rules |
| Fat Loss + Increase Muscle | Uses Fat Loss rules |

### 6.2 Sets
Always 3 sets for all exercises, all experience levels.

### 6.3 Rest Periods

| Canonical Rating | Rest (seconds) |
|-----------------|----------------|
| > 80 | 120 |
| 50-80 | 90 |
| < 50 | 60 |

---

## 7. Warnings & Edge Cases

### 7.1 Warning Types

| Warning | Trigger | User Message |
|---------|---------|--------------|
| `attachmentWarning` | Cables selected, no cable attachments | "You've selected Cable Machines but no cable attachments..." |
| `exerciseRepeats` | Soft constraint relaxed | "Some exercises repeated due to limited equipment..." |
| `noExercisesForMuscle` | Zero candidates for muscle | "No exercises available for [muscle]..." |
| `insufficientExercises` | Found < requested count | "Only found X of Y exercises..." |
| `lowFillRate` | Programme < 100% filled | "Programme only X% filled..." |

### 7.2 Attachment Warning Logic

```swift
if equipment.contains("cable_machines") {
    let cableAttachments = ["Straight Bar", "Rope", "D-Handles", "EZ-Bar Cable"]
    if !attachments.contains(where: cableAttachments.contains) {
        warnings.append(.attachmentWarning)
    }
}
```

---

## 8. Video Integration

### 8.1 Bunny.net CDN
- Base URL: `https://vz-f673c4c2-345.b-cdn.net/`
- Formats: MP4 (video), PNG/JPG (images)
- Coverage: ~98% of exercises have media

### 8.2 URL Construction
```
Base URL + filename = Full URL
https://vz-f673c4c2-345.b-cdn.net/ + exercise_video.mp4
```

---

## 9. Injury/Contraindication Handling

**Important:** Injuries do NOT filter exercises from programmes.

Instead:
1. Exercises with contraindications are included in programme
2. UI displays warning icon for contraindicated exercises
3. User can still perform the exercise at their discretion

```swift
// WorkoutOverviewView checks at display time:
let contraindications = fetchContraindications(for: exercise)
let hasWarning = !Set(contraindications).isDisjoint(with: userInjuries)
// Show warning icon if hasWarning
```

---

## 10. Database Generation

### 10.1 Running the Generator

```bash
cd database-management
python3 create_database_prod.py
```

### 10.2 Required Files
- `train_exercise_database_prod.csv`
- `train_exercise_contraindications_prod.csv`
- `exercise_video_mapping.csv`
- `constants.json`

### 10.3 Output
- `trAInSwift/Resources/exercises.db` (generated directly in Swift resources)

### 10.4 After Generation
1. Database is automatically in correct location
2. Build and run iOS app (⌘R)
3. If constants.json changed, copy to `trAInSwift/Resources/`

---

## 11. Swift Components

### 11.1 Key Classes

| Class | File | Purpose |
|-------|------|---------|
| `ConstantsManager` | Services/ConstantsManager.swift | Loads constants.json, provides mappings |
| `ExerciseDatabaseManager` | Services/ExerciseDatabaseManager.swift | GRDB database queries |
| `ExerciseRepository` | Services/ExerciseRepository.swift | MCV selection, pool building |
| `DynamicProgramGenerator` | Services/DynamicProgramGenerator.swift | Orchestrates generation |

### 11.2 Key Models

| Model | File | Purpose |
|-------|------|---------|
| `DBExercise` | Models/DatabaseModels.swift | Exercise record from DB |
| `ExerciseDatabaseFilter` | Models/DatabaseModels.swift | Query filter parameters |
| `QuestionnaireData` | Models/QuestionnaireData.swift | User questionnaire answers |

---

## Appendix A: Equipment Specific Values

Equipment items that appear in `equipment_specific` column:

**Barbells:**
- Squat Rack, Flat Bench Press, Incline Bench Press, Decline Bench Press
- Landmine Attachment, Hip Thrust Bench, Preacher Bench, Smith Machine

**Cables:**
- Single Adjustable Cable Machine, Dual Cable Machine
- Lat Pull Down Machine, Cable Row Machine

**Pin-Loaded Machines:**
- Leg Press Machine, Leg Extension Machine, Lying Leg Curl Machine
- Seated Leg Curl Machine, Standing Calf Raise Machine, Seated Calf Raise Machine
- Hip Abduction Machine, Hip Adduction Machine, Assisted Pull-Up/Dip Machine

**Plate-Loaded Machines:**
- Leg Press Machine, Hack Squat Machine, Leg Extension Machine
- Lying Leg Curl Machine, Seated Leg Curl Machine
- Standing Calf Raise Machine, Seated Calf Raise Machine, Glute Kickback Machine

**Other:**
- Ab Wheel, Dip Bars, Flat Bench, Pull-Up Bar, Roman Chair, Captains Chair

---

## Appendix B: Attachment Distribution

| Attachment | Exercise Count | Primary Use |
|------------|----------------|-------------|
| Straight Bar | ~5 | Cable curls, pushdowns |
| Rope | ~5 | Cable crunches, tricep pushdowns |
| D-Handles | ~7 | Cable flys, chest press |
| EZ-Bar | ~4 | Barbell curls, skull crushers |
| EZ-Bar Cable | ~4 | Cable curls, extensions |
| Ankle Strap | ~1 | Cable hip adduction |
| Resistance Band | ~2 | Banded pull-ups/dips |
| Weight Belt | ~2 | Weighted pull-ups/dips |

---

## Appendix C: Muscle Groups

Primary muscles used in exercise database:
- Back, Biceps, Calves, Chest, Core, Forearms
- Glutes, Hamstrings, Quads, Shoulders, Traps, Triceps
- Rear Delts, Adductors
