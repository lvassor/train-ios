# Program Generation Algorithm Failure Analysis Report

**Date:** January 17, 2026
**Issue:** Critical program generation algorithm failure
**Severity:** High - affects core app functionality
**Status:** Under Investigation

## Executive Summary
The program generation algorithm is failing to select adequate exercises despite having full equipment access (all 7 equipment types selected). This is NOT an equipment validation issue - that's working correctly. The algorithm itself is producing insufficient exercise selections.

## Evidence from Debug Logs

### 1. Equipment Validation: ‚úÖ WORKING CORRECTLY
```
üîß [EQUIPMENT DEBUG] Equipment validation triggered
üîß [EQUIPMENT DEBUG] Equipment count: 7
üîß [EQUIPMENT DEBUG] Equipment list: ["barbells", "dumbbells", "kettlebells", "cable_machines", "pin_loaded", "plate_loaded", "other"]
üîß [EQUIPMENT DEBUG] ‚úÖ Equipment validation passed - User has 7 pieces of equipment
```
**Analysis:** The user has ALL equipment types, and equipment validation passes without triggering any warnings.

### 2. Program Generation Algorithm: ‚ùå FAILING
```
üîç Selecting exercises for: Chest (need 3)
üèä Building user pool for Chest
   Pool size: 6
üéØ MCV Heuristic selecting 3 exercises from pool of 6
   ‚úÖ Selected: Barbell Bench Press (rating: 100)
   üìä Selected 1 of 3 requested exercises
üîÑ Attempting soft constraint relaxation for Chest
   üìä Selected 1 of 3 requested exercises
‚úÖ Selection complete: 1 exercises for Chest
```

**Critical Issue:** Algorithm has 6 available exercises but only selects 1 out of 3 needed.

### 3. Biceps Selection Failure
```
üîç Selecting exercises for: Biceps (need 2)
üèä Building user pool for Biceps
   Pool size: 1
üéØ MCV Heuristic selecting 2 exercises from pool of 1
   üìä Selected 1 of 2 requested exercises
```

**Critical Issue:** Only 1 exercise available in pool when there should be multiple bicep exercises with full equipment.

### 4. Core Selection Complete Failure
```
üîç Selecting exercises for: Core (need 1)
üèä Building user pool for Core
   Pool size: 0
   ‚ö†Ô∏è NO EXERCISES FOUND for Core - session will skip this muscle group
```

**Critical Issue:** Zero core exercises found despite having all equipment types.

## Root Cause Analysis

### Potential Causes (in order of likelihood):

#### 1. **MCV Heuristic Algorithm Bug**
The constraint solver (`MCV Heuristic`) is being too restrictive. Evidence:
- Has pool of 6 exercises for chest, only selects 1
- Constraint relaxation attempts are failing
- Algorithm appears to be applying constraints that shouldn't exist with full equipment

#### 2. **Equipment Mapping Corruption**
The questionnaire equipment names may not be properly mapping to database equipment names:

**Questionnaire Format:**
```
["barbells", "dumbbells", "kettlebells", "cable_machines", "pin_loaded", "plate_loaded", "other"]
```

**Database Format (from logs):**
```
["Barbells", "Dumbbells", "Kettlebells", "Cables", "Pin-Loaded Machines", "Plate-Loaded Machines", "Other"]
```

**Analysis:** The mapping appears correct in logs, but there could be case sensitivity or string matching issues.

#### 3. **Database Query Issues**
The exercise database queries may be:
- Missing exercises due to corrupted data
- Using incorrect WHERE clauses for equipment filtering
- Not properly joining exercise-equipment relationships

#### 4. **Session Constraint Conflicts**
The "already used exercises" tracking may be incorrectly excluding exercises:
```
üö´ Session canonical names already used: ["Bench Chest Press"]
```

#### 5. **Recent Code Changes Impact**
Since this was working before today's changes, the issue likely stems from:
- Changes to equipment validation logic that affected downstream processing
- Database schema modifications
- Constraint solver parameter changes
- Equipment mapping function modifications

## Warning Generation Chain

The warnings displayed in the modal are generated by this chain:
1. `DynamicProgramGenerator` fails to find adequate exercises
2. Creates `ExerciseSelectionWarning` objects with specific messages
3. `WorkoutViewModel` collects warnings and shows "Program Generation Notice" modal
4. User sees: "Only found 1 of 3 exercises for Chest" etc.

## Specific Examples of Failure

### Example 1: Chest Exercise Pool Reduction
- **Expected:** With full equipment, should have 15+ chest exercises available
- **Actual:** Pool size of only 6 exercises
- **Selected:** Only 1 out of 3 needed exercises
- **Impact:** 67% selection failure rate

### Example 2: Core Exercise Complete Absence
- **Expected:** Multiple core exercises (planks, crunches, Russian twists, etc.)
- **Actual:** Pool size of 0 exercises
- **Impact:** 100% failure - entire muscle group skipped

### Example 3: Constraint Solver Logic Error
- **Scenario:** Pool has adequate exercises, but MCV heuristic fails
- **Evidence:** "Selected 1 of 3 requested exercises" despite "pool of 6"
- **Implication:** The selection algorithm logic is fundamentally broken

## Program Generation Full Log Summary

```
‚ö†Ô∏è Warnings: 3

üìã FULL PROGRAM BREAKDOWN:
   Push: 4 exercises (expected: 6) - 67% fill rate
      - Barbell Bench Press ‚úÖ
      - Barbell Overhead Press ‚úÖ
      - Barbell Front Raise ‚úÖ
      - Assisted Dips ‚úÖ

   Pull: 4 exercises (expected: 6) - 67% fill rate
      - Pendlay Row ‚úÖ
      - T-Bar Row ‚úÖ
      - Barbell Curl ‚úÖ
      - Assisted Pull Up ‚úÖ

   Legs: 6 exercises (expected: 6) - 100% fill rate
      - Barbell Back Squat ‚úÖ
      - Hack Squat ‚úÖ
      - Barbell Deadlift ‚úÖ
      - Kettlebell Swing ‚úÖ
      - Barbell Hip Thrust ‚úÖ
      - Dumbbell Reverse Lunge ‚úÖ

Total: 14 exercises (expected: 18) - 78% fill rate
```

**Analysis:** Only Legs session achieved full exercise selection. Push and Pull sessions are significantly underfilled.

## User Impact

### Immediate Impact
- Users receive incomplete workout programs
- Missing muscle groups (Core completely absent)
- Reduced exercise variety leading to poor training outcomes
- Warning modals disrupt user experience

### Long-term Impact
- Users may lose confidence in program quality
- Reduced training effectiveness due to incomplete programs
- Potential user churn due to poor program generation

## Recommendations for Investigation

1. **Check MCV Heuristic Implementation**
   - Verify constraint solving logic in `DynamicProgramGenerator.swift`
   - Look for recent changes to exercise selection algorithms

2. **Validate Database Integrity**
   - Confirm all exercises exist in database
   - Verify equipment-exercise relationships are intact
   - Check for data corruption from recent changes

3. **Audit Equipment Mapping**
   - Trace questionnaire equipment ‚Üí database equipment conversion
   - Verify case sensitivity and string matching

4. **Review Recent Git Changes**
   - Identify what was modified today that could affect program generation
   - Look for changes to constraint parameters, database queries, or selection logic

5. **Database Verification Queries**
   - Check exercise count by muscle group
   - Verify equipment-exercise relationships
   - Confirm Core exercises exist in database

## Next Steps

1. **Immediate:** Review git history for changes to program generation logic
2. **Priority 1:** Debug MCV heuristic selection algorithm
3. **Priority 2:** Validate database integrity and exercise availability
4. **Priority 3:** Implement additional logging for constraint solver decisions

## Files Requiring Investigation

- `/trAInSwift/Services/DynamicProgramGenerator.swift` - Main generation logic
- `/trAInSwift/Services/ExerciseRepository.swift` - Database queries
- `/trAInSwift/ViewModels/WorkoutViewModel.swift` - Warning handling
- `/trAInSwift/Models/QuestionnaireData.swift` - Equipment mapping

## ROOT CAUSE IDENTIFIED: Equipment Mapping Bug

**CRITICAL DISCOVERY:** The issue is NOT with the MCV heuristic or database corruption. It's a fundamental bug in the equipment mapping function.

### The Bug
**File:** `/trAInSwift/Models/DatabaseModels.swift`
**Function:** `ExerciseDatabaseFilter.mapEquipmentFromQuestionnaire()`
**Problem:** Core exercises in database use `equipment_category = "Bodyweight"` but Swift mapping only produces `"Other"`, never `"Bodyweight"`

### Database Evidence
```sql
-- Core exercises in database (9 total):
SELECT display_name, equipment_category FROM exercises
WHERE primary_muscle = 'Core' AND is_in_programme = 1;

Plank|Bodyweight
Side Plank|Bodyweight
Dead Bug|Bodyweight
Russian Twist|Bodyweight
Cable Crunch|Cables
Dumbbell Suitcase Carry|Dumbbells
-- etc.
```

### Swift Mapping Bug
```swift
// Current (BROKEN):
case "bodyweight", "other":
    dbEquipment.append("Other")  // Only adds "Other", not "Bodyweight"!

// Should be:
case "bodyweight", "other":
    dbEquipment.append("Other")
    dbEquipment.append("Bodyweight")  // Missing this line!
```

### Python vs Swift Discrepancy Explained
- **Python simulator:** Works with correct equipment mapping (likely older, working version)
- **Swift implementation:** Has critical equipment mapping bug since schema split "Bodyweight" and "Other"
- **Result:** Python finds Core exercises, Swift finds 0 Core exercises

### Impact Analysis
- **Core:** 100% failure (0/9 exercises found) - equipment mapping bug
- **Chest:** 67% failure (1/3 exercises found) - likely same issue affecting bodyweight exercises
- **Biceps:** 50% failure (1/2 exercises found) - similar equipment constraint issues

## Conclusion

This is a **critical equipment mapping bug** affecting the core functionality of the app. The fix is simple but essential: update the Swift equipment mapping to include both "Other" and "Bodyweight" categories when users select "other" equipment.

**Immediate Fix Required:**
1. Update `mapEquipmentFromQuestionnaire()` to include "Bodyweight" category
2. Test with same user profile to verify Core exercises are found
3. Validate all muscle groups achieve expected fill rates

This explains why the Python simulator works better than the Swift implementation - they have divergent equipment mapping logic.

---

**Report Generated:** 2026-01-17 22:54 UTC
**Generated By:** Claude Code Analysis
**Files Referenced:** Debug logs, program generation output, equipment validation logs