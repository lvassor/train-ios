# Exercise Database Schema

This document describes the SQLite database schema for the trAIn iOS app exercise database.

## Database File
- **File**: `exercises.db`
- **Location**: `trAInSwift/Resources/exercises.db`
- **Generated by**: `create_database_prod.py`

## Tables

### `exercises`
Core exercise data with MCV heuristic support.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `exercise_id` | TEXT | PRIMARY KEY | Unique identifier (e.g., "EX001") |
| `canonical_name` | TEXT | NOT NULL | Grouped name for deduplication (e.g., "Bench Press") |
| `display_name` | TEXT | NOT NULL | User-facing name (e.g., "Barbell Flat Bench Press") |
| `equipment_category` | TEXT | NOT NULL | Equipment category (e.g., "Barbells", "Dumbbells") |
| `equipment_specific` | TEXT | nullable | Specific equipment variant (e.g., "Squat Rack") |
| `complexity_level` | TEXT | NOT NULL, CHECK('all', '1', '2', '3') | Exercise complexity requirement |
| `is_isolation` | INTEGER | NOT NULL, DEFAULT 0 | 0 or 1 - whether exercise is isolation |
| `primary_muscle` | TEXT | NOT NULL | Main muscle group targeted |
| `secondary_muscle` | TEXT | nullable | Optional secondary muscle |
| `instructions` | TEXT | nullable | Exercise instructions |
| `is_in_programme` | INTEGER | NOT NULL, DEFAULT 1 | 0 or 1 - include in programme generation |
| `canonical_rating` | INTEGER | NOT NULL, DEFAULT 50, CHECK(0-100) | MCV heuristic ordering score |
| `progression_id` | TEXT | nullable | Comma-separated exercise_ids for progressions |
| `regression_id` | TEXT | nullable | Comma-separated exercise_ids for regressions |

#### Complexity Level Meanings
- `"all"` = Available to everyone (maps to user level 0)
- `"1"` = Requires at least beginner level
- `"2"` = Requires at least intermediate level
- `"3"` = Requires at least advanced level

#### Canonical Rating
- 0-100 score used for MCV heuristic ordering
- Higher = more important/compound
- Isolation exercises typically 10-30
- Compound exercises typically 40-90

### `exercise_contraindications`
Links exercises to injury warnings.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | INTEGER | PRIMARY KEY AUTOINCREMENT | Unique row ID |
| `canonical_name` | TEXT | NOT NULL | Links to exercises.canonical_name |
| `injury_type` | TEXT | NOT NULL | Injury type (e.g., "Back", "Shoulders") |

**Unique constraint**: `(canonical_name, injury_type)`

## Indexes

Performance indexes for common queries:

- `idx_exercises_canonical` on `exercises(canonical_name)`
- `idx_exercises_category` on `exercises(equipment_category)`
- `idx_exercises_specific` on `exercises(equipment_specific)`
- `idx_exercises_complexity` on `exercises(complexity_level)`
- `idx_exercises_muscle` on `exercises(primary_muscle)`
- `idx_exercises_isolation` on `exercises(is_isolation)`
- `idx_exercises_programme` on `exercises(is_in_programme)`
- `idx_exercises_rating` on `exercises(canonical_rating)`
- `idx_exercises_progression` on `exercises(progression_id)`
- `idx_exercises_regression` on `exercises(regression_id)`
- `idx_contraindications_canonical` on `exercise_contraindications(canonical_name)`
- `idx_contraindications_injury` on `exercise_contraindications(injury_type)`

## Data Sources

### Input Files
- `train_exercise_database_prod.xlsx` (sheet: "master") → `exercises` table
- `train_exercise_contraindications_prod.xlsx` (sheet: "Sheet1") → `exercise_contraindications` table

### Column Mappings
The database creation script handles:
- Legacy integer complexity levels → new string format
- Missing `canonical_rating` → calculated defaults based on complexity/isolation
- Missing `progression_id`/`regression_id` → set to NULL

## MCV Heuristic Algorithm

The new programme generation uses the MCV (Most Constrained Variable) heuristic:

### Selection Process
1. Filter by user level: `complexity_level ≤ user_experience_level`
2. Filter by equipment: `equipment_category IN user_equipment`
3. For each template slot, build candidate list by muscle group
4. **MCV Loop**:
   - Find unfilled slot with fewest candidates
   - From candidates, select exercise with highest `canonical_rating`
   - Remove `canonical_name` from session (no variations within session)
   - Remove `display_name` from programme (no exact repeats across sessions)

### Constraint Relaxation
When MCV gets stuck (zero candidates):
- **Soft constraint**: Allow `display_name` repeats across sessions
- Set warning flag for user notification

### Hard vs Soft Constraints
**Hard** (never relaxed):
- Equipment availability
- User experience level
- No `canonical_name` repeats within session

**Soft** (relaxed when stuck):
- No `display_name` repeats across sessions

## Migration Notes

This schema supports the new MCV heuristic while maintaining backward compatibility:
- `complexity_level` changed from INTEGER to TEXT
- Added `canonical_rating`, `progression_id`, `regression_id` columns
- Removed dependency on separate experience level tables
- Experience rules now hardcoded in Swift code